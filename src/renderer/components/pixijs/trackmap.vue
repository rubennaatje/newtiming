
<template>
  <div class="stage" />
</template>
<script>
/* eslint-disable no-undef */
import { Viewport } from 'pixi-viewport';
// eslint-disable-next-line no-unused-vars
import tweenManager from 'pixi-tween';
import { mapGetters } from 'vuex';
import { TrackOOP } from './trackoop';

export default {
  computed: {
    ...mapGetters({
      allCars: 'cars/getAll',
    }),
  },
  watch: {
    allCars (newValue, oldValue) {
      if (!this.carsAreSet) {
        this.carsAreSet = true;
        this.allCars.forEach((a, i) => this.AddCar(i));
      }
    },
  },
  beforeDestroy () {
    this.app.destroy();
  },
  mounted () {
    this.startPixi();
  },
  methods: {
    initPixi () {
      this.app = new PIXI.Application({
        // transparent: true,
        antialias: true,
      });
      this.$el.appendChild(this.app.view);
      this.app.renderer.view.style.display = 'block';
      this.app.renderer.autoResize = true;
      this.app.renderer.resize(window.innerWidth, window.innerHeight);

      this.viewport = new Viewport({
        screenWidth: window.innerWidth,
        screenHeight: window.innerHeight,
        worldWidth: 1000,
        worldHeight: 1000,

        // interaction: this.app.renderer.plugins.interaction // the interaction module is important for wheel to work properly when renderer.view is placed or scaled
      });
      this.app.stage.addChild(this.viewport);
    },
    startPixi () {
      this.initPixi();

      this.viewport
        .drag()
        .pinch()
        .wheel()
        .decelerate();

      this.path = new TrackOOP(
        'M 131 319.6 C 97.3 343.4 62.6 365.8 27.6 387.7 C 22.4 390.9 17.7 395.2 11.9 397 C 9.9 397.7 7.4 398.5 5.6 397.5 C 4.1 396.7 3.2 394.8 3 393.1 C 2.6 388.3 6.5 382.5 7.9 379.6 C 17.3 359.4 24.2 342 34.1 324.1 C 39 315.2 44.1 306.3 50.5 298.4 C 59.7 286.9 71.4 277.4 81.8 266.9 C 91.3 257.3 100.8 247.7 110.2 238.1 C 116.7 231.4 124.1 225.4 129.7 217.9 C 133.8 212.5 135.9 205.8 139.8 200.3 C 142.8 196.3 145.9 192.1 149.8 189.1 C 154.4 185.5 159.9 183 165.4 181 C 172.5 178.4 180.5 178.7 187.5 175.8 C 193 173.5 197.7 169.9 202.5 166.6 C 211.1 160.8 218.9 154 227.1 147.8 C 235.7 141.3 244.2 134.8 252.9 128.5 C 259.5 123.7 266.2 118.9 273.1 114.4 C 276.3 112.3 279.5 110.3 282.8 108.5 C 287.9 105.8 293.2 103.5 298.6 101.3 C 312.7 95.7 327.4 91.7 341.6 86.5 C 395.8 66.8 488.2 29.9 502.9 24.4 C 514.3 20.1 525.3 14.6 537.2 12.2 C 539.7 11.6 542.3 11.1 544.8 11.7 C 548.4 12.4 551.4 14.4 554.2 16.6 C 557 18.8 558.7 21.9 561 24.5 C 562.3 25.8 563.2 27.2 564.6 28.1 C 566.6 29.4 568.8 30.1 571 30.5 C 573 30.9 575 30.7 577 30.2 C 583.8 28.7 589.7 24.7 596.2 22.3 C 600 20.9 603.8 19.3 607.8 18.6 C 610.9 18 614.2 17.4 617.3 18.1 C 620.5 18.9 623.8 20.4 626.1 22.8 C 642.4 40 660.1 60.9 676.8 80.3 C 681.4 85.6 686.2 90.8 690.4 96.4 C 692.1 98.6 694 100.7 695.1 103.3 C 696.5 106.5 697.6 110 697.3 113.4 C 697 116.2 695.6 118.8 694 121 C 692.6 122.9 690.7 124.5 688.6 125.7 C 686.5 126.9 684.1 127.6 681.7 127.9 C 679.6 128.2 677.4 128.2 675.4 127.6 C 672.9 127 670.6 125.6 668.6 124.1 C 665.6 121.8 663.5 118.7 661.1 115.8 C 652.6 105.9 642.8 91.5 637 85.1 C 635 83 631.6 82.2 628.6 81.7 C 625.9 81.3 623 81.5 620.2 82.2 C 615 83.5 610.5 86.8 605.5 88.9 C 598.5 91.9 591.5 94.6 584.5 97.3 C 576.6 100.4 568.7 103.7 560.7 106.5 C 551.9 109.5 543 112 534 114.4 C 517.5 118.9 500.6 122.2 484 126.8 C 479.1 128.2 474.1 129.2 469.4 131.2 C 465.9 132.8 462.4 134.7 459.4 137.2 C 456.9 139.2 454.4 141.6 452.8 144.5 C 450.8 148 450.1 152.2 449.4 156.2 C 448.7 159.8 448.8 163.6 448.8 167.3 C 448.7 171.6 448.6 176 449.1 180.3 C 449.8 185.6 450.8 190.9 452.5 196 C 454 200.3 455.8 204.5 458.5 208.2 C 460.2 210.6 462.6 212.6 464.9 214.5 C 467.5 216.6 470.3 218.3 473.1 220 C 476.3 222 479.6 224 483.1 225.4 C 496 230.6 510 232.5 523.4 236.4 C 541.3 241.5 559.2 246.9 576.9 252.7 C 583.1 254.7 589.6 256.1 595.4 259.1 C 598 260.5 600.5 262.3 602.5 264.4 C 604.6 266.7 606.4 269.3 607.3 272.2 C 608.3 275.2 608.5 278.5 608.2 281.7 C 607.9 285 606.6 288 605.7 291.2 C 604 296.5 601 301.4 600.1 307 C 599.6 310.2 599.6 313.7 600.4 316.9 C 601.1 320.3 602.6 323.7 604.6 326.6 C 605.6 327.9 606.9 328.8 608.1 329.7 C 616.5 335.8 625.7 340.7 635 344.9 C 647.6 350.5 661.5 355.6 672.5 364.5 C 675 366.6 677.4 369.3 678.8 372.3 C 680 374.9 680.8 377.9 680.5 380.8 C 680.3 384.5 678.6 388.1 676.7 391.2 C 669.6 403.1 663.2 412.9 654.8 423.3 C 652.4 426.3 649.3 428.8 646 430.7 C 643.1 432.3 639.9 433.4 636.6 434 C 631.9 434.8 627.2 434.5 622.5 433.9 C 613.5 432.8 604.7 430.2 596.1 427.3 C 588.1 424.7 580.2 421.6 572.9 417.5 C 563.2 412.1 554.3 405.3 545.6 398.3 C 537 391.3 528.5 383.8 521 375.5 C 511.2 364.7 503.1 352.4 494.6 340.4 C 487.8 330.8 482.2 320.2 475 310.9 C 469.5 303.7 464 296.3 456.9 290.6 C 450.6 285.5 442.9 282.3 435.6 278.6 C 427.9 274.8 420.2 271.2 412.1 268.4 C 398.9 263.8 385.4 260.1 371.7 257.7 C 366.3 256.8 360.7 255.8 355.2 256.4 C 349.8 256.9 344.5 258.9 339.4 261 C 330.8 264.4 323.1 269.8 314.9 274 C 303.5 279.9 292.4 286.5 280.5 291.3 C 274.6 293.7 268.4 295.3 262.3 296.9 C 256 298.6 249.6 300 243.3 301.4 C 222.6 305.9 189.7 314.1 181.2 314.1 C 179.5 314.1 176.8 312.3 175.9 310.3 C 175.2 309 175.9 307.3 176 305.9 C 176.2 302.8 177.5 299.6 176.7 296.7 C 176.2 295.1 175.3 293.6 174 292.7 C 172.9 292 171.6 291.7 170.3 291.8 C 168.1 291.9 166.1 293.1 164.3 294.5 C 152.2 303.4 142.4 311.6 131 319.6 C 131 319.6 131 319.6 131 319.6 Z',
        7001
      );

      // this.path.lineStyle(14.0, 0xffffff);

      this.path.addPitlane(
        'M 176 307.7 C 176 307.7 178 302.6 178.4 299.8 C 178.8 297.3 179 294.6 178.4 292.1 C 178 290.3 177.2 288.6 176 287.3 C 174.6 285.8 172.6 284.7 170.6 284.4 C 168 284.1 165.4 285.2 163 286.1 C 159.5 287.4 156.5 289.6 153.4 291.6 C 149.2 294.3 145.3 297.5 141.3 300.4 C 138.8 302.2 136.2 303.8 134 305.8 C 130.3 309 128.3 313.4 124.1 316.6 C 117.6 321.4 93.4 337.7 78 348.2 C 60.4 360.2 41.7 372.8 25 384.3 C 23.6 385.2 22.1 386.2 20.4 386.5 C 19.1 386.7 17.7 386.4 16.6 385.8 C 15.3 385.1 14.1 383.9 13.4 382.5 C 12.8 381 13 379.2 13.1 377.6 C 13.5 373.1 15 368.9 16.4 364.6 C 18 359.8 22 350.6 22 350.6'
      );

      this.path.addSector(
        'M 131 319.6 C 97.3 343.4 62.6 365.8 27.6 387.7 C 22.4 390.9 17.7 395.2 11.9 397 C 9.9 397.7 7.4 398.5 5.6 397.5 C 4.1 396.7 3.2 394.8 3 393.1 C 2.6 388.3 6.5 382.5 7.9 379.6 C 17.3 359.4 24.2 342 34.1 324.1 C 39 315.2 44.1 306.3 50.5 298.4 C 59.7 286.9 71.4 277.4 81.8 266.9 C 91.3 257.3 100.8 247.7 110.2 238.1 C 116.7 231.4 124.1 225.4 129.7 217.9 C 133.8 212.5 135.9 205.8 139.8 200.3 C 142.8 196.3 145.9 192.1 149.8 189.1 C 154.4 185.5 159.9 183 165.4 181 C 172.5 178.4 180.5 178.7 187.5 175.8 C 193 173.5 197.7 169.9 202.5 166.6 C 211.1 160.8 218.9 154 227.1 147.8 C 235.7 141.3 244.2 134.8 252.9 128.5 C 259.5 123.7 266.2 118.9 273.1 114.4 C 276.3 112.3 279.5 110.3 282.8 108.5 C 287.9 105.8 293.2 103.5 298.6 101.3 C 312.7 95.7 327.4 91.7 341.6 86.5 C 395.8 66.8 488.2 29.9 502.9 24.4',
        's1'
      );

      this.path.addSector(
        'M 502.9 24.4 C 514.3 20.1 525.3 14.6 537.2 12.2 C 539.7 11.6 542.3 11.1 544.8 11.7 C 548.4 12.4 551.4 14.4 554.2 16.6 C 557 18.8 558.7 21.9 561 24.5 C 562.3 25.8 563.2 27.2 564.6 28.1 C 566.6 29.4 568.8 30.1 571 30.5 C 573 30.9 575 30.7 577 30.2 C 583.8 28.7 589.7 24.7 596.2 22.3 C 600 20.9 603.8 19.3 607.8 18.6 C 610.9 18 614.2 17.4 617.3 18.1 C 620.5 18.9 623.8 20.4 626.1 22.8 C 642.4 40 660.1 60.9 676.8 80.3 C 681.4 85.6 686.2 90.8 690.4 96.4 C 692.1 98.6 694 100.7 695.1 103.3 C 696.5 106.5 697.6 110 697.3 113.4 C 697 116.2 695.6 118.8 694 121 C 692.6 122.9 690.7 124.5 688.6 125.7 C 686.5 126.9 684.1 127.6 681.7 127.9 C 679.6 128.2 677.4 128.2 675.4 127.6 C 672.9 127 670.6 125.6 668.6 124.1 C 665.6 121.8 663.5 118.7 661.1 115.8 C 652.6 105.9 642.8 91.5 637 85.1 C 635 83 631.6 82.2 628.6 81.7 C 625.9 81.3 623 81.5 620.2 82.2 C 615 83.5 610.5 86.8 605.5 88.9 C 598.5 91.9 591.5 94.6 584.5 97.3 C 576.6 100.4 568.7 103.7 560.7 106.5 C 551.9 109.5 543 112 534 114.4 C 517.5 118.9 500.6 122.2 484 126.8 C 479.1 128.2 474.1 129.2 469.4 131.2 C 465.9 132.8 462.4 134.7 459.4 137.2 C 456.9 139.2 454.4 141.6 452.8 144.5 C 450.8 148 450.1 152.2 449.4 156.2 C 448.7 159.8 448.8 163.6 448.8 167.3 C 448.7 171.6 448.6 176 449.1 180.3 C 449.8 185.6 450.8 190.9 452.5 196 C 454 200.3 455.8 204.5 458.5 208.2 C 460.2 210.6 462.6 212.6 464.9 214.5 C 467.5 216.6 470.3 218.3 473.1 220 C 476.3 222 479.6 224 483.1 225.4 C 496 230.6 510 232.5 523.4 236.4 C 541.3 241.5 559.2 246.9 576.9 252.7 C 583.1 254.7 589.6 256.1 595.4 259.1 C 598 260.5 600.5 262.3 602.5 264.4 C 604.6 266.7 606.4 269.3 607.3 272.2 C 608.3 275.2 608.5 278.5 608.2 281.7 C 607.9 285 606.6 288 605.7 291.2 C 604 296.5 601 301.4 600.1 307 C 599.6 310.2 599.6 313.7 600.4 316.9 C 601.1 320.3 602.6 323.7 604.6 326.6 C 605.6 327.9 606.9 328.8 608.1 329.7 C 616.5 335.8 625.7 340.7 635 344.9 C 647.6 350.5 661.5 355.6 672.5 364.5 C 675 366.6 677.4 369.3 678.8 372.3 C 680 374.9 680.8 377.9 680.5 380.8 C 680.3 384.5 678.6 388.1 676.7 391.2 C 672.9 397.6 669.3 403.3 665.5 408.9',
        's1',
        0xFFFF00
      );

      this.path.addSector(
        'M 665.5 408.9 C 662.2 413.7 658.7 418.4 654.8 423.3 C 652.4 426.3 649.3 428.8 646 430.7 C 643.1 432.3 639.9 433.4 636.6 434 C 631.9 434.8 627.2 434.5 622.5 433.9 C 613.5 432.8 604.7 430.2 596.1 427.3 C 588.1 424.7 580.2 421.6 572.9 417.5 C 563.2 412.1 554.3 405.3 545.6 398.3 C 537 391.3 528.5 383.8 521 375.5 C 511.2 364.7 503.1 352.4 494.6 340.4 C 487.8 330.8 482.2 320.2 475 310.9 C 469.5 303.7 464 296.3 456.9 290.6 C 450.6 285.5 442.9 282.3 435.6 278.6 C 427.9 274.8 420.2 271.2 412.1 268.4 C 398.9 263.8 385.4 260.1 371.7 257.7 C 366.3 256.8 360.7 255.8 355.2 256.4 C 349.8 256.9 344.5 258.9 339.4 261 C 330.8 264.4 323.1 269.8 314.9 274 C 303.5 279.9 292.4 286.5 280.5 291.3 C 274.6 293.7 268.4 295.3 262.3 296.9 C 256 298.6 249.6 300 243.3 301.4 C 222.6 305.9 189.7 314.1 181.2 314.1 C 179.5 314.1 176.8 312.3 175.9 310.3 C 175.2 309 175.9 307.3 176 305.9 C 176.2 302.8 177.5 299.6 176.7 296.7 C 176.2 295.1 175.3 293.6 174 292.7 C 172.9 292 171.6 291.7 170.3 291.8 C 168.1 291.9 166.1 293.1 164.3 294.5 C 152.2 303.4 142.4 311.6 131 319.6',
        's1',
        0x0000FF
      );

      this.path.drawMarker(0, 'fl', 10, 2, 0xFF0000, 'FL');

      this.viewport.addChild(this.path);

      this.viewport.sortableChildren = true;

      //   this.viewport.follow(bunny);
      this.viewport.zoomPercent(5);

      // Listen for animate update and update the tween manager
      this.app.ticker.add(function (delta) {
        PIXI.tweenManager.update();
      });
    },
    AddCar (index) {
      console.log(index);
      const car = new PIXI.Graphics();

      car.beginFill(0xFFFFFF, 1);
      car.drawCircle(0, 0, 5);
      switch (this.allCars[index].category) {
      case 'LMGTEAm':
        car.tint = 0xFFA500;
        break;
      case 'LMGTEPro':
        car.tint = 0x00FF00;
        break;
      case 'LMP2':
        car.tint = 0x0000FF;
        break;

      case 'LMP1':
        car.tint = 0xFF0000;
        break;
      }

      console.log(this.allCars[index]);
      const text = new PIXI.Text(this.allCars[index].carnumber, {
        fontFamily: 'Helvetica',
        fontWeight: 'bold',
        fontSize: 8,
        fill: 0xFFFFFF,
        align: 'center',
      });
      text.position.x = -5;
      if (this.allCars[index].carnumber.length === 1) {
        text.position.x = -3;
      }
      text.position.y = -5;
      text.resolution = 8;

      //   ghost.tint = 0xff0000;

      car.addChild(text);
      car.zIndex = 5;
      // init tween
      const tween = PIXI.tweenManager.createTween(car);
      tween.time = 503;
      tween.from({ x: 0 }).to({ x: 250 });
      tween.start();
      tween.loop = true;

      tween.on('repeat', loopCount => {
        const point = this.path.getPointAtPercentage(
          this.allCars[index].percentage
        );

        tween.from({ x: tween._to.x, y: tween._to.y }).to({
          x: point.x,
          y: point.y,
        });
      });

      this.viewport.addChild(car);
      this.viewport.follow(car, {
        radius: 50,
        speed: 2,
        acceleration: 100,
      });
    },
  },
};
</script>
